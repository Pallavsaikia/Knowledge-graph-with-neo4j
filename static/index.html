<!DOCTYPE html>
<html>
<head><title>Live Audio Call with Bot</title></head>
<body>
  <h1>Audio Call</h1>
  <label>Call ID: <input id="callId" value="testcall"/></label>
  <button onclick="startCall()">Join Call</button>

  <h3>Bot Messages:</h3>
  <div id="botMessages" style="border:1px solid black; height: 150px; overflow-y: auto;"></div>

  <script>
    let ws;
    let audioContext;
    let source;
    let processor;
    let audioBufferQueue = [];
    let playingAudioContext;

    async function startCall() {
      const callId = document.getElementById("callId").value;
      ws = new WebSocket(`ws://localhost:8000/ws/${callId}`);

      ws.binaryType = "arraybuffer";

      ws.onmessage = function(event) {
        if (typeof event.data === "string") {
          // text message
          document.getElementById("botMessages").innerHTML += "<p>" + event.data + "</p>";
        } else {
          // audio bytes from bot TTS
          playAudio(event.data);
        }
      };

      audioContext = new AudioContext();
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      source = audioContext.createMediaStreamSource(stream);
      processor = audioContext.createScriptProcessor(4096, 1, 1);

      source.connect(processor);
      processor.connect(audioContext.destination);

      processor.onaudioprocess = function(e) {
        const input = e.inputBuffer.getChannelData(0);
        const int16 = convertFloat32ToInt16(input);
        ws.send(int16.buffer);
      };

      ws.onopen = () => {
        console.log("WebSocket opened");
      };

      ws.onclose = () => {
        console.log("WebSocket closed");
      };
    }

    function convertFloat32ToInt16(buffer) {
      let l = buffer.length;
      const buf = new Int16Array(l);
      while (l--) {
        let s = Math.max(-1, Math.min(1, buffer[l]));
        buf[l] = s < 0 ? s * 0x8000 : s * 0x7FFF;
      }
      return buf;
    }

    function playAudio(arrayBuffer) {
      if (!playingAudioContext) {
        playingAudioContext = new AudioContext();
      }
      playingAudioContext.decodeAudioData(arrayBuffer, (buffer) => {
        const source = playingAudioContext.createBufferSource();
        source.buffer = buffer;
        source.connect(playingAudioContext.destination);
        source.start(0);
      });
    }
  </script>
</body>
</html>
